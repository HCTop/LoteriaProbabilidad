name: Actualizar HistÃ³ricos de LoterÃ­as

on:
  # Ejecutar cada dÃ­a a las 00:30 hora EspaÃ±a (22:30 UTC en invierno, 21:30 en verano)
  schedule:
    - cron: '30 22 * * *'
  
  # TambiÃ©n permitir ejecuciÃ³n manual
  workflow_dispatch:

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Mostrar informaciÃ³n del sistema
        run: |
          echo "ðŸ“… Fecha actual: $(date)"
          echo "ðŸ Python: $(python --version)"
          echo "ðŸ“ Directorio: $(pwd)"
      
      - name: Ejecutar script de descarga
        run: |
          cd scripts
          python actualizar_datos.py
        timeout-minutes: 30
      
      - name: Verificar archivos generados
        run: |
          echo "ðŸ“Š Archivos CSV generados:"
          ls -la app/src/main/res/raw/*.csv 2>/dev/null || echo "No se encontraron archivos"
          echo ""
          echo "ðŸ“ˆ Conteo de lÃ­neas por archivo:"
          for csv in app/src/main/res/raw/*.csv; do
            if [ -f "$csv" ]; then
              NOMBRE=$(basename "$csv")
              LINEAS=$(wc -l < "$csv")
              echo "  $NOMBRE: $LINEAS lÃ­neas"
            fi
          done
      
      - name: Verificar cambios en los CSV
        id: verify
        run: |
          if git diff --quiet app/src/main/res/raw/*.csv 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ No hay cambios en los datos"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¬ Se detectaron cambios en los CSV"
            git diff --stat app/src/main/res/raw/*.csv
          fi
      
      - name: Commit y push de los cambios
        if: steps.verify.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # AÃ±adir solo los CSV actualizados
          git add app/src/main/res/raw/*.csv
          
          # Crear commit con fecha y hora
          FECHA=$(date +'%Y-%m-%d %H:%M')
          git commit -m "ðŸ“Š ActualizaciÃ³n automÃ¡tica de histÃ³ricos - $FECHA" \
                     -m "Datos descargados de fuentes oficiales"
          
          # Push al repositorio
          git push
      
      - name: Resumen de la ejecuciÃ³n
        run: |
          echo "## ðŸ“Š Resumen de ActualizaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Archivo | Sorteos |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          for csv in app/src/main/res/raw/*.csv; do
            if [ -f "$csv" ]; then
              NOMBRE=$(basename "$csv")
              LINEAS=$(($(wc -l < "$csv") - 1))
              echo "| $NOMBRE | $LINEAS |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify.outputs.changed }}" == "true" ]; then
            echo "âœ… **Datos actualizados correctamente**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Sin cambios detectados**" >> $GITHUB_STEP_SUMMARY
          fi
